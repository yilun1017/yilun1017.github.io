name: Jekyll site CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build the site in the jekyll/builder container
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_PAGES }}
      run: |       
        git config --global url."https://".insteadOf git://
        git config --global url."https://github.com/".insteadOf git@github.com:
        git submodule update --init --recursive
        remote_repo="https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
        remote_branch=master
        
        bundle exec rake build
        cd public
        touch .nojekyll
        git init
        git config user.name "github-actions-bot"
        git config user.email "github-actions-bot@users.noreply.github.com"
        git add .
        git commit -m "Deploy GitHub Pages"
        git push --force "${remote_repo}" master:${remote_branch}
